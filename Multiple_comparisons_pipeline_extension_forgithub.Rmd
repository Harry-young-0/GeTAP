---
title: "Multiple_comparisons_pipeline_extension.rmd"
author: "Henry Young"
date: "2023-08-02"
output: html_document
---

CURRENT FAVPLOT = 1b.3-TraitgroupvsGene_groupcol_FULL_ALPHA.pdf
AND 1d.3-TraitgroupSubcatvsGene_groupcol_FULL_ALPHA
# STEP 0: Notes on using this notebook
Prerequisites to load in :
```{r}
library(tidyverse)
library(viridis)
library(scales)

```

Copied from final_pipleine - setup file directories etc INCOMPLETE
```{r}


#First line to clear out environment
rm(list=ls())

# Can we extract all files from a folder _test to get the gene names

#1. setting the file directory to where you want it to go DRIVE:/YOUR_FILE_DIRECTORY - THIS SHOULD BE THE SAME AS IN FINAL PIPELINE
file_directory = "DRIVE:/YOUR_FILE_DIRECTORY"

Full_trait_database = read_csv(paste0(file_directory,"/Trait and Tissue Groups/Full_trait_database.csv"))
Full_trait_database = unique(Full_trait_database)
file_directory=paste0(file_directory,"/Heatmaps_test")
#windows e.g: file_directory = "C:/Users/hy14913/OneDrive - University of Bristol/Desktop/May23_test"
#mac e.g: file_directory ="/Users/hy14913/Documents/Local_work_folder/JUL_TEST"

try(if(file_directory=="C:/Documents/Example directory") stop("Please enter your file_directory so the pipeline knows where to save"))




```


### Setting up finding the gene names

```{r, echo=FALSE, results='hide', message=FALSE}

setwd(paste0(file_directory))
files_in_wd <- list.files(file_directory)
list_of_completed_genes  <- files_in_wd[grepl("_test", files_in_wd)]  

for(gene in list_of_completed_genes){
  print(gene)
  assign("df_temp", read_csv( paste0(file_directory,"/",gene,"/Final_data/final_df.csv")))
  if(exists("df_merge")==T){
    df_merge =rbind(df_temp, df_merge)
  }else{
    df_merge =df_temp
  }
  
}

genes_for_heatmap = unique(df_merge$`Gene Symbol`)
```

set up filing system
```{r}
if(file.exists(paste0(file_directory,"/Plots"))){
print("Plots folder exists, moving on")
}else{
dir.create(paste0(file_directory,"/Plots"))
}

```



# Heatmaps
## colour storage (from circos)
I've commented out tissues. These will be dealt with separately if at all
```{r}
grid_col = c(`Body Fat/Size` = "#0DF485",
             `Diet` = "#39FFC0",
            `Metabolism (inc. Diabetes)` ="#32DCC1",
             `Tumours (Benign/Cancer)` ="#32CCDC" ,
             `Atrophy/Dystrophy` = "#0DB5F4",
            `Congenital Defects` = "#3277DC",
             `Cardiovascular Traits` = "#4532DC",
             `Blood/Vascular Traits` ="#6C39FF",
             Inflammation ="#9A32DC", #  or #AA98A970
            `Respiratory` ="#C432DC",
             `Renal/Urinary` = "#DC32D0",
            `Physical Activity` = "#DC324D",
             `Digestive Traits` ="#DC4132",
            `Nervous System/Brain` = "#DC5D32",
             `Bone Traits (inc. Dental)` = "#DC8732",
            `Muscle/Tendon Traits` = "#DCA732",
            `Physical Injury` = "#DCD232",
            `Alcohol-related Disease` ="#BCDC32",
             `Life Span` ="#92DC32",
             `Female Specific Traits` = "#43DC32",
            `Male Specific Traits` = "#00f556",
            `Disease (unknown origin)` ="#00f577",
            `Other/Unspecified` ="#C9C7BD",
            `Other Gene Expression Change` ="#78C47D"
             # Tissues:
             # Blood = "#CC5500",
             # `Cultured Cells` = "#00FFFF",
             # Digestive ="#A7C7E7",
             # Endocrine = "#FF4433",
             # Fat = "#E0115F",
             # `Female Reproductive Tissue` = "#0C5F7D",
             # Heart = "#80461B",
             # Lymphatic ="#023020",
             # `Male Specific Tissue` ="#FFA500",
             # Mammary = "#E9846E",
             # Muscle = "#FFBF00",
             # Nervous = "#90EE90",
             # `Respiratory Tissue` = "#D673C9",
             # Skin = "#00A36C",
             # Vascular ="#630330"
             
)

trait_order =c("Body Fat/Size",
                                                    "Diet",
            "Metabolism (inc. Diabetes)",
            "Tumours (Benign/Cancer)",
            "Atrophy/Dystrophy", 
            "Congenital Defects", 
            "Cardiovascular Traits",
            "Blood/Vascular Traits",
            "Inflammation" , 
            "Respiratory",
            "Renal/Urinary",
            "Physical Activity",
            "Digestive Traits",
            "Nervous System/Brain",
            "Bone Traits (inc. Dental)",
            "Muscle/Tendon Traits",
            "Physical Injury",
            "Alcohol-related Disease",
            "Life Span",
            "Female Specific Traits",
            "Male Specific Traits",
            "Disease (unknown origin)",
            "Other Gene Expression Change",
            "Other/Unspecified"
            )


```



## Heat map (August 23)
#### 1b.2 and 3 Traitgroup vs gene with full dataset - alpha based on raw rsid count
```{r, fig.width=12, fig.height=10}
# Just for my data to be removed!
df_backup = df_merge %>% dplyr::select(-traitgroup, -Subcat, -Alt_Subcat)
Full_trait_database = unique(Full_trait_database)

test =left_join(df_backup, Full_trait_database)
setdiff(test,df_merge)
# end
#test_backup=test

for_legend = Full_trait_database %>% 
  select(traitgroup) %>%
  unique()

test = test[which(test$traitgroup!= "Other/Unspecified"),]

# OR WITH ALPHA
test_counts = test %>% 
  dplyr::select(
                 traitgroup, 
                 `Gene Symbol`,
                 rsid) %>%
  unique() %>%
  group_by(
                 traitgroup, 
                 `Gene Symbol`)%>%
  summarise(traitgroup_count=n())
test = left_join(test, test_counts)
test=unique(test)
test$traitgroup_count=as.numeric(test$traitgroup_count)

df_red = test %>% dplyr::select(`Gene Symbol`, traitgroup, traitgroup_count)
df_red =unique(df_red)

df_red$traitgroup_count =as.numeric(df_red$traitgroup_count)
df_red =df_red %>%
  group_by(`Gene Symbol`)%>%
  mutate(alpha =traitgroup_count/sum(traitgroup_count))
  

for_legend = for_legend %>%
  mutate(`Gene Symbol` = "Legend",
         traitgroup_count=max(df_red$traitgroup_count),
         alpha=1) 
df_red=rbind(df_red,for_legend)
df_red= df_red[which(df_red$traitgroup!= "Other/Unspecified"),]
df_red$traitgroup =factor(df_red$traitgroup, levels=trait_order)
df_red$`Gene Symbol` =factor(df_red$`Gene Symbol`, levels=c(genes_for_heatmap,"Legend"))



  ggplot(data= df_red)+
    geom_tile(aes(x=`Gene Symbol`, y=traitgroup, fill=traitgroup, alpha=traitgroup_count))+
    scale_fill_manual(values=grid_col)+
    theme(axis.text.x = element_text(size=12, angle=45, hjust=1), 
          strip.text.y.right = element_text(angle = 0),
          strip.background.x =element_rect(fill="grey20"),
          strip.text.x = element_text(colour = "white"),
          legend.position = "none",
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(), 
          axis.line = element_line(colour = "black"))+
    scale_y_discrete(limits=rev)
   
ggsave(paste0(file_directory,"/Plots/A-TraitgroupvsGene_groupcol_alpha.pdf"), width=4, height=6)



```


####1d. Traitgroup WITH SUBCAT vs Gene simple 

```{r, fig.width=17, fig.height=15}
test = df_merge %>% dplyr::select(-c(traitgroup, Subcat, Alt_Subcat))
test =left_join(test,Full_trait_database)
test = test %>% dplyr::filter(traitgroup!= "Other/Unspecified")
test$Subcat =ifelse(test$Subcat=="Blood Traits", test$Alt_Subcat, test$Subcat)
test$traitgroup = factor(test$traitgroup, levels =trait_order )

  ggplot()+
    geom_tile(data= test, aes(x=`Gene Symbol`, y=Subcat, fill=traitgroup, height=0.8))+
    scale_fill_manual(values=grid_col)+
    theme(axis.text.x = element_text(size=12, angle=45, hjust=1), 
          strip.text.y.right = element_text(angle = 0, face="bold"),
          strip.background.y = element_blank(),
          strip.background.x =element_rect(fill="grey20"),
          strip.text.x = element_text(colour = "white"),
          legend.position = "none",
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(), 
          axis.line = element_line(colour = "black")
          )+
    facet_grid(cols=vars(`Gene Symbol`),rows=vars(traitgroup), scales = "free", space="free" )+
    scale_y_discrete(limits=rev, position ="left")+
    scale_alpha_manual(values=c(1,0.3))

ggsave(paste0(file_directory,"/Plots/B1-TraitgroupSubcatvsGene_groupcol.pdf"), width=12, height=15)

# Or with alpha
test = df_merge %>% dplyr::select(-c(traitgroup, Subcat, Alt_Subcat))
test =left_join(test,Full_trait_database)
test = test %>% dplyr::filter(traitgroup!= "Other/Unspecified")
test$Subcat =ifelse(test$Subcat=="Blood Traits", test$Alt_Subcat, test$Subcat)
test_counts = test %>% 
  dplyr::select(trait,
                Subcat,
                 traitgroup, 
                 `Gene Symbol`,
                 rsid,
                p) %>%
  unique() %>%
  group_by(trait,
           Subcat,
                 traitgroup, 
                 `Gene Symbol`)%>%
  summarise(subcat_count=n()) %>%
  group_by(Subcat,
                 traitgroup, 
                 `Gene Symbol`)%>%
  summarise(subcat_count=sum(subcat_count))
test = left_join(test, test_counts)
test=unique(test)
test$subcat_count=as.numeric(test$subcat_count)


df_red = test %>% dplyr::select(`Gene Symbol`, traitgroup,Subcat, subcat_count, trait)
df_red =unique(df_red)

df_red$subcat_count =as.numeric(df_red$subcat_count)
df_red =df_red %>%
  group_by(`Gene Symbol`)%>%
  mutate(alpha =subcat_count/max(subcat_count))
  
for_legend = Full_trait_database %>% 
  select(traitgroup,Subcat,Alt_Subcat) %>%
  unique() %>%
  mutate(`Gene Symbol` = "Legend",
         subcat_count=max(df_red$subcat_count),
         alpha=1) 
for_legend$Subcat =ifelse(for_legend$Subcat=="Blood Traits", for_legend$Alt_Subcat, for_legend$Subcat)
for_legend = for_legend %>% dplyr::select(-Alt_Subcat)
df_red=rbind(df_red,for_legend)
df_red=df_red %>% filter(!is.na(`Gene Symbol`))
df_red$traitgroup =factor(df_red$traitgroup, levels=trait_order)
df_red= df_red[which(df_red$traitgroup!= "Other/Unspecified"),]
df_red$`Gene Symbol` =factor(df_red$`Gene Symbol`, levels=c(genes_for_heatmap,"Legend"))

  ggplot(data= df_red)+
    geom_tile( aes(x=`Gene Symbol`, y=Subcat, fill=traitgroup, height=0.8,alpha=alpha, width=0.9))+
    scale_fill_manual(values=grid_col)+
    theme(axis.text.x = element_text(size=8, angle=45, hjust=1), 
          strip.text.y.right = element_text(angle = 0, face="bold"),
          strip.background.y = element_blank(),
          strip.background.x =element_rect(fill="grey20"),
          strip.text.x = element_text(colour = "white"),
          legend.position = "none",
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(), 
          axis.line = element_line(colour = "black"),
          panel.spacing.y = unit(0.2,"lines")
          )+
    facet_grid(  rows=vars(traitgroup), scales = "free", space="free" )+
    scale_y_discrete(limits=rev, position ="left")

ggsave(paste0(file_directory,"/Plots/B2-SubcatvsGene_groupcol_ALPHA_.pdf"), width=150, height=400, unit ="mm")

#ALTERNATE COLOURSCHEME ####
df_red %>% filter(`Gene Symbol`!="Legend")%>%
  ggplot()+
    geom_tile( aes(x=`Gene Symbol`, y=Subcat, fill=subcat_count, height=0.8, width=0.9))+
    geom_text(aes(x=`Gene Symbol`, y=Subcat,label=subcat_count), size=2)+ # Comment in/out for text overlay
    scale_fill_viridis_c(trans = "log", breaks = trans_breaks("log", function(x) 10^x),
                       labels = trans_format("log", math_format(10^.x)))+
    theme(axis.text.x = element_text(size=8, angle=45, hjust=1), 
          strip.text.y.right = element_text(angle = 0, face="bold"),
          strip.background.y = element_blank(),
          strip.background.x =element_rect(fill="grey20"),
          strip.text.x = element_text(colour = "white"),
          legend.position = "bottom",
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background  = element_rect(colour = "grey99"), 
          axis.line = element_line(colour = "black"),
          panel.spacing.y = unit(0.2,"lines")
          )+
    facet_grid(  rows=vars(traitgroup), scales = "free", space="free" )+
    scale_y_discrete(limits=rev, position ="left")

ggsave(paste0(file_directory,"/Plots/B3-SubcatvsGene_colby_n.rsid-trait.pdf"), width=150, height=220, unit ="mm")





```

## Bar chart of how many per gene KEEP
```{r fig.width=12, fig.height=7}
df =df_merge
test_counts = df %>% 
  dplyr::select(trait, traitgroup, `Gene Symbol`,rsid, p) %>%
  unique() %>% 
  group_by(trait, traitgroup, `Gene Symbol`)%>%
  summarise(trait_count = n())

test_counts$traitgroup = factor(test_counts$traitgroup, levels =trait_order)

ggplot(test_counts[which(test_counts$traitgroup!="Other/Unspecified"),], aes(x=`Gene Symbol`, fill=traitgroup))+
  geom_col(aes(y= trait_count))+
  scale_fill_manual(values=grid_col)+
  theme(axis.text.x = element_text(size=15, angle=45, hjust=1), 
        axis.text.y = element_text(size=15, face="bold"),
          strip.text.y.right = element_text(angle = 0, face="bold"),
          strip.background.y = element_blank(),
          strip.background.x =element_rect(fill="grey20"),
          strip.text.x = element_text(colour = "white"),
          #legend.position = "none",
          panel.background = element_blank(), 
          axis.line = element_line(colour = "black"),
          panel.border = element_rect(fill=NA)
          )+
 
  scale_y_continuous(expand = expansion(mult =c(0, 0.1)))
 #SAVE it
ggsave(paste0(file_directory,"/Plots/C1-Summary_bar.pdf"), width=120, height=80, unit="mm")

```


## Bar chart of how many per gene relative to itself - nicer proportions?
```{r fig.width=12, fig.height=7}
df =df_merge
test_counts = df %>% 
  dplyr::select(trait, traitgroup, `Gene Symbol`,rsid, p) %>%
  unique() %>% 
  group_by(trait, traitgroup, `Gene Symbol`)%>%
  summarise(trait_count = n()) %>%
  group_by(`Gene Symbol`)%>%
  mutate(trait_count.adj=(trait_count/sum(trait_count))*100) %>% 
  dplyr::select(`Gene Symbol`,traitgroup,trait_count.adj) %>% 
  group_by(`Gene Symbol`,traitgroup)%>%
  summarise(trait_count.adj = sum(trait_count.adj))
STA_count = df %>% 
  dplyr::select(trait, traitgroup, `Gene Symbol`,rsid, p) %>%
  unique() %>% 
  group_by(trait, traitgroup, `Gene Symbol`)%>%
  summarise(trait_count = n()) %>% 
  group_by(`Gene Symbol`) %>%
  summarise(trait_count= sum(trait_count))


test_counts$traitgroup = factor(test_counts$traitgroup, levels =trait_order)

ggplot()+
  geom_col(data=test_counts, aes(x=`Gene Symbol`,y= trait_count.adj, fill=traitgroup))+
  geom_text(data=STA_count,aes(x=`Gene Symbol`,y=103, label=trait_count))+
  scale_fill_manual(values=grid_col)+
  theme(axis.text.x = element_text(size=15, angle=45, hjust=1), 
        axis.text.y = element_text(size=15, face="bold"),
          strip.text.y.right = element_text(angle = 0, face="bold"),
          strip.background.y = element_blank(),
          strip.background.x =element_rect(fill="grey20"),
          strip.text.x = element_text(colour = "white"),
          #legend.position = "none",
          panel.background = element_blank(), 
          axis.line = element_line(colour = "black"),
          panel.border = element_rect(fill=NA)
          )+
 
  scale_y_continuous(expand = expansion(mult =c(0,0.04)))+
  labs(y="Percentage of STAs / Total STAs")
 #SAVE it
ggsave(paste0(file_directory,"/Plots/C2-Summary_bar_proportions.pdf"), width=140, height=130, unit="mm")

```